#!/bin/bash

dhistfile="$HOME"/.dmenu_history

exe=$(
	( tac "$dhistfile" 2>/dev/null
		echo $PATH | awk -F: '{for (i=1;i<=NF;i++) print $i}' |
			xargs -I{} find {}/ \( -type f -o -type l \) -executable -printf '%f\n' )\
		| awk '{if (!a[$0]) { a[$0]=1; print; }}'\
		| dmenu -p 'Run:' -i -fn 'Luxi Sans-8:normal' )
[[ -z "$exe" ]] && exit 0

## To also check last-cleanup timestamp, not just size
# ts=$(printf '%(%s)T' -1)
# ts_chk=$(getfattr -n user.ts.cleanup --only-values "$dhistfile" 2>/dev/null)
# if [[ $? -ne 0 ]]
# then ts_chk=$(( $RANDOM / 5 )) # ~0-3300
# else ts_chk=$(( $ts - $ts_chk ))
# fi
ts_chk=0

if [[ $ts_chk -gt 3000 || $(stat --format=%s "$dhistfile") -gt 1500 ]]; then
	## First, remove the duplicate entries
	awk '{if (!a[$0]) { a[$0]=1; print; }}' "$dhistfile" > "$dhistfile".clean
	mv "$dhistfile"{.clean,}
	## Second, if it's still too large, trim it
	if [[ $(stat --format=%s "$dhistfile") -gt 1500 ]]; then
		tac "$dhistfile" | sed -n '1,100p' | tac > "$dhistfile".clean
		mv "$dhistfile"{.clean,}
	fi
	# setfattr -n user.ts.cleanup -v "$ts" "$dhistfile"
fi

echo "$exe" >> "$dhistfile"

exec "$exe" "$@"
